import matplotlib.pyplot as plt
from matplotlib.patches import Rectangle

def pip_ploting_graph_real(
                        ns=7, a=10, b=5, aa=34, 

                        storage = "./",
                        group_plan = [{'device': [0], 'layer': [0]}, {'device': [0], 'layer': [0]}, {'device': [0], 'layer': [0]}, {'device': [0], 'layer': [0]}],

):
    # ----------------------
    # Visualization
    # ----------------------
    fp_schedule = {(0, 0, -1): (0.0, 2.2388059701492535), (0, 1, -1): (2.2388059701492535, 4.477611940298507), (0, 2, -1): (4.477611940298507, 6.7164179104477615), (0, 3, -1): (6.7164179104477615, 8.955223880597014), (0, 4, -1): (53.38805970149254, 55.62686567164179), (1, 0, 1): (2.334328358208955, 3.5940298507462685), (1, 0, 2): (2.334328358208955, 3.5940298507462685), (1, 0, 3): (2.334328358208955, 3.5940298507462685), (1, 0, 4): (2.334328358208955, 3.5940298507462685), (1, 0, 5): (2.334328358208955, 3.5940298507462685), (1, 0, 6): (2.334328358208955, 3.5940298507462685), (1, 0, 7): (2.334328358208955, 3.5940298507462685), (1, 0, 8): (2.334328358208955, 3.5940298507462685), (1, 1, 1): (5.6940298507462686, 6.953731343283582), (1, 1, 2): (5.6940298507462686, 6.953731343283582), (1, 1, 3): (6.535820895522388, 7.795522388059702), (1, 1, 4): (5.6940298507462686, 6.953731343283582), (1, 1, 5): (5.6940298507462686, 6.953731343283582), (1, 1, 6): (5.6940298507462686, 6.953731343283582), (1, 1, 7): (5.276119402985074, 6.535820895522388), (1, 1, 8): (5.276119402985074, 6.535820895522388), (1, 2, 1): (7.795522388059702, 9.055223880597016), (1, 2, 2): (7.795522388059702, 9.055223880597016), (1, 2, 3): (7.795522388059702, 9.055223880597016), (1, 2, 4): (7.795522388059702, 9.055223880597016), (1, 2, 5): (7.795522388059702, 9.055223880597016), (1, 2, 6): (17.386567164179105, 18.64626865671642), (1, 2, 7): (7.795522388059702, 9.055223880597016), (1, 2, 8): (7.795522388059702, 9.055223880597016), (1, 3, 1): (24.434328358208955, 25.69402985074627), (1, 3, 2): (24.434328358208955, 25.69402985074627), (1, 3, 3): (25.274626865671642, 26.534328358208956), (1, 3, 4): (26.534328358208956, 27.79402985074627), (1, 3, 5): (24.434328358208955, 25.69402985074627), (1, 3, 6): (24.434328358208955, 25.69402985074627), (1, 3, 7): (26.534328358208956, 27.79402985074627), (1, 3, 8): (27.37462686567164, 28.634328358208954), (1, 4, 1): (60.061194029850746, 61.32089552238806), (1, 4, 2): (60.061194029850746, 61.32089552238806), (1, 4, 3): (60.48059701492537, 61.74029850746269), (1, 4, 4): (60.061194029850746, 61.32089552238806), (1, 4, 5): (60.061194029850746, 61.32089552238806), (1, 4, 6): (60.061194029850746, 61.32089552238806), (1, 4, 7): (60.061194029850746, 61.32089552238806), (1, 4, 8): (68.36865671641792, 69.62835820895522), (2, 0, -1): (0.0, 1.4940298507462686), (2, 1, -1): (1.4940298507462686, 2.988059701492537), (2, 2, -1): (2.988059701492537, 4.482089552238806), (2, 3, -1): (4.482089552238806, 5.976119402985074), (2, 4, -1): (53.713432835820896, 55.20746268656716), (3, 0, 1): (1.4940298507462686, 2.334328358208955), (3, 0, 2): (1.4940298507462686, 2.334328358208955), (3, 0, 3): (1.4940298507462686, 2.334328358208955), (3, 0, 4): (1.4940298507462686, 2.334328358208955), (3, 0, 5): (1.4940298507462686, 2.334328358208955), (3, 0, 6): (1.4940298507462686, 2.334328358208955), (3, 0, 7): (1.4940298507462686, 2.334328358208955), (3, 0, 8): (1.4940298507462686, 2.334328358208955), (3, 1, 1): (3.5970149253731343, 4.437313432835821), (3, 1, 2): (3.5955223880597016, 4.435820895522388), (3, 1, 3): (4.435820895522388, 5.276119402985074), (3, 1, 4): (4.853731343283582, 5.6940298507462686), (3, 1, 5): (3.5955223880597016, 4.435820895522388), (3, 1, 6): (3.5955223880597016, 4.435820895522388), (3, 1, 7): (4.435820895522388, 5.276119402985074), (3, 1, 8): (4.437313432835821, 5.277611940298508), (3, 2, 1): (6.953731343283582, 7.794029850746269), (3, 2, 2): (6.953731343283582, 7.794029850746269), (3, 2, 3): (6.953731343283582, 7.794029850746269), (3, 2, 4): (6.953731343283582, 7.794029850746269), (3, 2, 5): (16.12686567164179, 16.96716417910448), (3, 2, 6): (6.953731343283582, 7.794029850746269), (3, 2, 7): (16.12686567164179, 16.96716417910448), (3, 2, 8): (7.794029850746269, 8.634328358208956), (3, 3, 1): (16.96716417910448, 17.807462686567163), (3, 3, 2): (24.434328358208955, 25.274626865671642), (3, 3, 3): (26.534328358208956, 27.37462686567164), (3, 3, 4): (27.79402985074627, 28.634328358208954), (3, 3, 5): (25.69402985074627, 26.534328358208956), (3, 3, 6): (24.434328358208955, 25.274626865671642), (3, 3, 7): (17.386567164179105, 18.22686567164179), (3, 3, 8): (25.69402985074627, 26.534328358208956), (3, 4, 1): (68.36865671641792, 69.2089552238806), (3, 4, 2): (68.36865671641792, 69.2089552238806), (3, 4, 3): (68.36865671641792, 69.2089552238806), (3, 4, 4): (60.48059701492537, 61.32089552238806), (3, 4, 5): (68.36865671641792, 69.2089552238806), (3, 4, 6): (68.36865671641792, 69.2089552238806), (3, 4, 7): (68.78805970149254, 69.62835820895522), (3, 4, 8): (69.2089552238806, 70.04925373134328), (4, 0, -1): (3.5940298507462685, 9.07910447761194), (4, 1, -1): (10.643283582089552, 16.128358208955223), (4, 2, -1): (33.940298507462686, 39.42537313432836), (4, 3, -1): (54.46268656716418, 59.94776119402985), (4, 4, -1): (74.89253731343284, 80.37761194029851), (5, 0, 1): (9.07910447761194, 16.12686567164179), (5, 0, 2): (9.07910447761194, 16.12686567164179), (5, 0, 3): (9.07910447761194, 16.12686567164179), (5, 0, 4): (9.07910447761194, 16.12686567164179), (5, 0, 5): (9.07910447761194, 16.12686567164179), (5, 0, 6): (9.07910447761194, 16.12686567164179), (5, 0, 7): (9.07910447761194, 16.12686567164179), (5, 0, 8): (9.07910447761194, 16.12686567164179), (5, 1, 1): (16.128358208955223, 23.176119402985076), (5, 1, 2): (16.128358208955223, 23.176119402985076), (5, 1, 3): (25.274626865671642, 32.322388059701495), (5, 1, 4): (16.128358208955223, 23.176119402985076), (5, 1, 5): (17.807462686567163, 24.855223880597016), (5, 1, 6): (16.128358208955223, 23.176119402985076), (5, 1, 7): (24.855223880597016, 31.902985074626866), (5, 1, 8): (18.22686567164179, 25.274626865671642), (5, 2, 1): (39.517910447761196, 46.56567164179104), (5, 2, 2): (39.517910447761196, 46.56567164179104), (5, 2, 3): (39.517910447761196, 46.56567164179104), (5, 2, 4): (39.517910447761196, 46.56567164179104), (5, 2, 5): (39.517910447761196, 46.56567164179104), (5, 2, 6): (39.517910447761196, 46.56567164179104), (5, 2, 7): (39.517910447761196, 46.56567164179104), (5, 2, 8): (39.517910447761196, 46.56567164179104), (5, 3, 1): (61.32089552238806, 68.36865671641792), (5, 3, 2): (61.32089552238806, 68.36865671641792), (5, 3, 3): (61.32089552238806, 68.36865671641792), (5, 3, 4): (61.74029850746269, 68.78805970149254), (5, 3, 5): (61.32089552238806, 68.36865671641792), (5, 3, 6): (61.32089552238806, 68.36865671641792), (5, 3, 7): (61.32089552238806, 68.36865671641792), (5, 3, 8): (61.32089552238806, 68.36865671641792), (5, 4, 1): (80.37761194029851, 87.42537313432835), (5, 4, 2): (80.37761194029851, 87.42537313432835), (5, 4, 3): (80.37761194029851, 87.42537313432835), (5, 4, 4): (80.37761194029851, 87.42537313432835), (5, 4, 5): (80.37761194029851, 87.42537313432835), (5, 4, 6): (80.37761194029851, 87.42537313432835), (5, 4, 7): (80.37761194029851, 87.42537313432835), (5, 4, 8): (80.37761194029851, 87.42537313432835), (6, 0, -1): (16.12686567164179, 20.51492537313433), (6, 1, -1): (32.47014925373134, 36.85820895522388), (6, 2, -1): (51.017910447761196, 55.40597014925373), (6, 3, -1): (70.98955223880597, 75.37761194029851), (6, 4, -1): (87.42537313432835, 91.81343283582089)}
    bp_schedule = {(0, 5, -1): (102.52537313432836, 108.62537313432836), (0, 6, -1): (108.65223880597014, 114.75223880597015), (0, 7, -1): (114.75223880597015, 120.85223880597015), (0, 8, -1): (120.85223880597015, 126.95223880597015), (0, 9, -1): (127.02089552238806, 133.12089552238805), (1, 5, 1): (57.12089552238806, 58.38059701492537), (1, 5, 2): (57.12089552238806, 58.38059701492537), (1, 5, 3): (57.12089552238806, 58.38059701492537), (1, 5, 4): (57.12089552238806, 58.38059701492537), (1, 5, 5): (57.12089552238806, 58.38059701492537), (1, 5, 6): (57.12089552238806, 58.38059701492537), (1, 5, 7): (58.38059701492537, 59.64029850746269), (1, 5, 8): (57.12089552238806, 58.38059701492537), (1, 6, 1): (77.51641791044776, 78.77611940298507), (1, 6, 2): (76.25671641791045, 77.51641791044776), (1, 6, 3): (76.67611940298508, 77.93582089552238), (1, 6, 4): (76.25671641791045, 77.51641791044776), (1, 6, 5): (76.67611940298508, 77.93582089552238), (1, 6, 6): (77.09701492537313, 78.35671641791045), (1, 6, 7): (77.93582089552238, 79.1955223880597), (1, 6, 8): (77.93582089552238, 79.1955223880597), (1, 7, 1): (95.68805970149253, 96.94776119402985), (1, 7, 2): (95.68805970149253, 96.94776119402985), (1, 7, 3): (95.68805970149253, 96.94776119402985), (1, 7, 4): (95.68805970149253, 96.94776119402985), (1, 7, 5): (95.68805970149253, 96.94776119402985), (1, 7, 6): (95.68805970149253, 96.94776119402985), (1, 7, 7): (95.68805970149253, 96.94776119402985), (1, 7, 8): (95.68805970149253, 96.94776119402985), (1, 8, 1): (112.07611940298507, 113.33582089552239), (1, 8, 2): (113.33582089552239, 114.5955223880597), (1, 8, 3): (113.33582089552239, 114.5955223880597), (1, 8, 4): (112.07611940298507, 113.33582089552239), (1, 8, 5): (112.07611940298507, 113.33582089552239), (1, 8, 6): (112.07611940298507, 113.33582089552239), (1, 8, 7): (112.07611940298507, 113.33582089552239), (1, 8, 8): (112.07611940298507, 113.33582089552239), (1, 9, 1): (125.76119402985074, 127.02089552238806), (1, 9, 2): (125.76119402985074, 127.02089552238806), (1, 9, 3): (125.76119402985074, 127.02089552238806), (1, 9, 4): (125.76119402985074, 127.02089552238806), (1, 9, 5): (125.76119402985074, 127.02089552238806), (1, 9, 6): (125.76119402985074, 127.02089552238806), (1, 9, 7): (125.76119402985074, 127.02089552238806), (1, 9, 8): (125.76119402985074, 127.02089552238806), (2, 5, -1): (112.68955223880597, 116.75671641791045), (2, 6, -1): (116.78358208955224, 120.85074626865672), (2, 7, -1): (120.85074626865672, 124.91791044776119), (2, 8, -1): (124.91791044776119, 128.98507462686567), (2, 9, -1): (128.98507462686567, 133.05223880597015), (3, 5, 1): (59.22089552238806, 60.061194029850746), (3, 5, 2): (59.64029850746269, 60.48059701492537), (3, 5, 3): (59.22089552238806, 60.061194029850746), (3, 5, 4): (59.22089552238806, 60.061194029850746), (3, 5, 5): (57.12089552238806, 57.961194029850745), (3, 5, 6): (58.38059701492537, 59.22089552238806), (3, 5, 7): (58.38059701492537, 59.22089552238806), (3, 5, 8): (58.38059701492537, 59.22089552238806), (3, 6, 1): (79.1955223880597, 80.03582089552239), (3, 6, 2): (76.99253731343283, 77.83283582089553), (3, 6, 3): (75.83582089552239, 76.67611940298508), (3, 6, 4): (77.09701492537313, 77.93731343283582), (3, 6, 5): (78.35671641791045, 79.19701492537314), (3, 6, 6): (78.77611940298507, 79.61641791044777), (3, 6, 7): (77.51641791044776, 78.35671641791045), (3, 6, 8): (76.67611940298508, 77.51641791044776), (3, 7, 1): (97.84179104477612, 98.6820895522388), (3, 7, 2): (98.6820895522388, 99.5223880597015), (3, 7, 3): (97.84179104477612, 98.6820895522388), (3, 7, 4): (97.84179104477612, 98.6820895522388), (3, 7, 5): (98.6820895522388, 99.5223880597015), (3, 7, 6): (97.84179104477612, 98.6820895522388), (3, 7, 7): (97.84179104477612, 98.6820895522388), (3, 7, 8): (98.6820895522388, 99.5223880597015), (3, 8, 1): (113.33582089552239, 114.17611940298508), (3, 8, 2): (114.17611940298508, 115.01641791044776), (3, 8, 3): (114.5955223880597, 115.43582089552238), (3, 8, 4): (114.17611940298508, 115.01641791044776), (3, 8, 5): (114.5955223880597, 115.43582089552238), (3, 8, 6): (112.07611940298507, 112.91641791044776), (3, 8, 7): (115.01641791044776, 115.85671641791045), (3, 8, 8): (113.33582089552239, 114.17611940298508), (3, 9, 1): (127.02089552238806, 127.86119402985075), (3, 9, 2): (127.02089552238806, 127.86119402985075), (3, 9, 3): (127.02089552238806, 127.86119402985075), (3, 9, 4): (127.02089552238806, 127.86119402985075), (3, 9, 5): (127.02089552238806, 127.86119402985075), (3, 9, 6): (127.02089552238806, 127.86119402985075), (3, 9, 7): (127.02089552238806, 127.86119402985075), (3, 9, 8): (127.02089552238806, 127.86119402985075), (4, 5, -1): (39.517910447761196, 54.46268656716418), (4, 6, -1): (59.94776119402985, 74.89253731343284), (4, 7, -1): (80.37761194029851, 95.3223880597015), (4, 8, -1): (95.3223880597015, 110.26716417910448), (4, 9, -1): (110.81641791044777, 125.76119402985074), (5, 5, 1): (32.47014925373134, 39.517910447761196), (5, 5, 2): (32.47014925373134, 39.517910447761196), (5, 5, 3): (32.47014925373134, 39.517910447761196), (5, 5, 4): (32.47014925373134, 39.517910447761196), (5, 5, 5): (32.47014925373134, 39.517910447761196), (5, 5, 6): (32.47014925373134, 39.517910447761196), (5, 5, 7): (32.47014925373134, 39.517910447761196), (5, 5, 8): (32.47014925373134, 39.517910447761196), (5, 6, 1): (48.81492537313433, 55.86268656716418), (5, 6, 2): (48.81492537313433, 55.86268656716418), (5, 6, 3): (48.81492537313433, 55.86268656716418), (5, 6, 4): (48.81492537313433, 55.86268656716418), (5, 6, 5): (48.81492537313433, 55.86268656716418), (5, 6, 6): (48.81492537313433, 55.86268656716418), (5, 6, 7): (48.81492537313433, 55.86268656716418), (5, 6, 8): (48.81492537313433, 55.86268656716418), (5, 7, 1): (70.04925373134328, 77.09701492537313), (5, 7, 2): (68.78805970149254, 75.83582089552239), (5, 7, 3): (69.2089552238806, 76.25671641791045), (5, 7, 4): (69.62835820895522, 76.67611940298508), (5, 7, 5): (70.04925373134328, 77.09701492537313), (5, 7, 6): (69.62835820895522, 76.67611940298508), (5, 7, 7): (69.62835820895522, 76.67611940298508), (5, 7, 8): (69.2089552238806, 76.25671641791045), (5, 8, 1): (87.42537313432835, 94.47313432835821), (5, 8, 2): (87.42537313432835, 94.47313432835821), (5, 8, 3): (87.42537313432835, 94.47313432835821), (5, 8, 4): (87.42537313432835, 94.47313432835821), (5, 8, 5): (87.42537313432835, 94.47313432835821), (5, 8, 6): (87.42537313432835, 94.47313432835821), (5, 8, 7): (87.42537313432835, 94.47313432835821), (5, 8, 8): (87.42537313432835, 94.47313432835821), (5, 9, 1): (103.76865671641791, 110.81641791044777), (5, 9, 2): (103.76865671641791, 110.81641791044777), (5, 9, 3): (103.76865671641791, 110.81641791044777), (5, 9, 4): (103.76865671641791, 110.81641791044777), (5, 9, 5): (103.76865671641791, 110.81641791044777), (5, 9, 6): (103.76865671641791, 110.81641791044777), (5, 9, 7): (103.76865671641791, 110.81641791044777), (5, 9, 8): (103.76865671641791, 110.81641791044777), (6, 5, -1): (20.51492537313433, 32.47014925373134), (6, 6, -1): (36.85820895522388, 48.8134328358209), (6, 7, -1): (55.40597014925373, 67.36119402985075), (6, 8, -1): (75.37761194029851, 87.33283582089553), (6, 9, -1): (91.81343283582089, 103.76865671641791)}
    gathering_schedule = {}

    s = ns
    stage_y = {ss: 3.3 * (s - ss - 1) for ss in range(s)}
    fig, ax = plt.subplots(figsize=(12, 5)) 

    # Forward Passes (green)
    #for (ss, m, subidx), (start, end) in fp_schedule.items():
    #    #print(s,m)
#
    #    interval = 3/(a-2)
    #    ys = stage_y[ss]
    #    yl = 3
    #    yll= 1.5
    #    if subidx != -1:
    #        ys = stage_y[ss] + (subidx-1)*interval 
    #        yl = interval
    #        yll = interval/2
#
#
    #    if ss%2 == 0:
    #        ax.add_patch(Rectangle((start, ys), end - start, yl, facecolor='limegreen', edgecolor='black', linewidth=1.0))
    #        ax.text(start + (end - start)/2, ys + yll, f"F{m}", ha='center', va='center', fontsize=8)
    #    else:
    #        ax.add_patch(Rectangle((start, ys), end - start, yl, facecolor='lightgreen', edgecolor='black', linewidth=1.0))
    #        ax.text(start + (end - start)/2, ys + yll, f"↓{m}↓", ha='center', va='center', fontsize=8)  
#
    ## Backward Passes (blue)
    #for (ss, m, subidx), (start, end) in bp_schedule.items():
#
    #    interval = 3/(a-2)
    #    ys = stage_y[ss]
    #    yl = 3
    #    yll= 1.5
    #    if subidx != -1:
    #        ys = stage_y[ss] + (subidx-1)*interval 
    #        yl = interval
    #        yll = interval/2
#
    #    if ss%2 == 0:
    #        ax.add_patch(Rectangle((start, ys), end - start, yl, facecolor='skyblue', edgecolor='black', linewidth=1.0))
    #        ax.text(start + (end - start)/2, ys + yll, f"B{m}", ha='center', va='center', fontsize=8)
    #    else: 
    #        ax.add_patch(Rectangle((start, ys), end - start, yl, facecolor='lightblue', edgecolor='black', linewidth=1.0))
    #        ax.text(start + (end - start)/2, ys + yll, f"↑{m}↑", ha='center', va='center', fontsize=8)
#
    ## Gathering cluster (blue)
    #for (ss,subidx), (start, end) in gathering_schedule.items():
#
    #    interval = 3/(aa-2)
    #    ys = stage_y[ss]
    #    yl = 3
    #    yll= 1.5
    #    if subidx != -1:
    #        ys = stage_y[ss] + (subidx-1)*interval 
    #        yl = interval
    #        yll = interval/2
#
    #    ax.add_patch(Rectangle((start, ys), end - start, yl, facecolor='yellow', edgecolor='black', linewidth=1.0))
    #    ax.text(start + (end - start)/2, ys + yll, f"gather", ha='center', va='center', fontsize=8)
    #
    ## Axes
    #ax.set_ylim(0, 3.3 * s)
#
    #if(gathering_schedule == {}):
    #    gathering_schedule = {0:(-1,0)}
    #    
    #ax.set_xlim(0, max(
    #    max(et for (_, et) in gathering_schedule.values()),
    #    max(et for (_, et) in bp_schedule.values()) if bp_schedule !={} else 0,
    #    max(et for (_, et) in fp_schedule.values())
    #) + 2)  
#
    #ax.set_yticks([stage_y[ss] + 2.0 for ss in range(s)])
    #ax.set_yticklabels([f"Step{ss}\nDevices:{group_plan[ss//2]['device']}\nLayers:{group_plan[ss//2]['layer']}" if ss %2 == 0 else f"Step {ss}\nCommunication" for ss in range(s)])
    #ax.set_xlabel("Time")
    #ax.set_title("1F1B Interleaved Pipeline Schedule(shared bandwidth with stage 2 OPT Real)")
    #ax.grid(False)
    #plt.tight_layout()
    plt.show()
    #plt.savefig(storage)

    compute_intervals = []
    bandwidth_intervals = []

    # Forward Pass schedule
    for (ss, m, subidx), (start, end) in fp_schedule.items():
        if ss % 2 == 0:
            # F{m} = compute
            compute_intervals.append((start, end))
        else:
            # ↓m↓ = bandwidth
            bandwidth_intervals.append((start, end))

    # Backward Pass schedule
    for (ss, m, subidx), (start, end) in bp_schedule.items():
        if ss % 2 == 0:
            # B{m} = compute
            compute_intervals.append((start, end))
        else:
            # ↑m↑ = bandwidth
            bandwidth_intervals.append((start, end))

    # Gathering schedule = bandwidth
    #for (ss, subidx), (start, end) in gathering_schedule.items():
    #    bandwidth_intervals.append((start, end))

    events = set()
    for s, e in compute_intervals + bandwidth_intervals:
        events.add(s)
        events.add(e)

    events = sorted(events)

    time_points = []
    compute_usage = []
    bandwidth_usage = []

    # Evaluate usage in each segment midpoint
    for i in range(len(events) - 1):
        t0, t1 = events[i], events[i+1]
        mid = (t0 + t1) / 2

        # Count compute tasks covering midpoint
        cu = sum(1 for s, e in compute_intervals if s <= mid < e)
        bu = sum(1 for s, e in bandwidth_intervals if s <= mid < e)
        bu = bu/4
        
        #bu = bu*2
        time_points.append(mid)
        compute_usage.append(cu)
        bandwidth_usage.append(bu)

    fig = plt.figure(figsize=(12, 4))

    plt.step(time_points, compute_usage, where='mid',
             linewidth=2, color='limegreen', label="Compute Usage")

    plt.step(time_points, bandwidth_usage, where='mid',
             linewidth=2, color='orange', label="Bandwidth Usage")

    plt.xlabel("Time")
    plt.ylabel("Resource Units Used")
    plt.title("Resource Utilization Over Time")
    plt.grid(True, linestyle="--", alpha=0.5)
    plt.legend()

    plt.tight_layout()
    plt.show()

    fig.savefig("gantt_resource_utilization.pdf", bbox_inches="tight", pad_inches=0)

if __name__ == "__main__":
    pip_ploting_graph_real()